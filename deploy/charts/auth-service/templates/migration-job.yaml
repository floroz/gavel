apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-migrate
  labels:
    app: {{ .Chart.Name }}
    component: migration
    # Helm hooks could be used here, but keeping it simple for Tilt first
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: {{ .Chart.Name }}
        component: migration
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z postgres-auth-postgresql 5432; do echo "Waiting for PostgreSQL..."; sleep 2; done']
      containers:
        - name: migrate
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /app/goose
            - -dir
            - /app/migrations
            - postgres
            - "$(DATABASE_URL)"
            - up
          env:
            - name: DATABASE_URL
            # We use authDbUrl for the migration tool
              value: {{ .Values.config.authDbUrl | quote }}
