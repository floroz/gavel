# Migration Job for User Stats Service using Goose
# Goose manages idempotency via the goose_db_version table - 
# it tracks which migrations have run and only executes new ones.
apiVersion: batch/v1
kind: Job
metadata:
  name: user-stats-service-migrate
  labels:
    app: user-stats-service
    component: migration
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: user-stats-service
        component: migration
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z postgres-stats-postgresql 5432; do echo "Waiting for PostgreSQL..."; sleep 2; done']
      containers:
        - name: migrate
          image: user-stats-service  # Uses the same image that Tilt builds
          command:
            - /app/goose
            - -dir
            - /app/migrations
            - postgres
            - "$(DATABASE_URL)"
            - up
          env:
            - name: DATABASE_URL
              value: "postgres://user:password@postgres-stats-postgresql:5432/stats_db?sslmode=disable"
